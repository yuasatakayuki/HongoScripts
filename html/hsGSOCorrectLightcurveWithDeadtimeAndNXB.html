<html>
<body>
<pre>
#!/bin/bash

#20090510 Shinya Yamada
#20090526 Takayuki Yuasa nxb dead-time correction implemented
#20090527 Takayuki Yuasa added energy band to title
#20091119 Takayuki Yuasa saa/cor bug fix
#20100115 Takayuki Yuasa output file names and output folder for plots were changed
#20100124 Takayuki Yuasa do away with gawk. use awk instead

#<span style="text-decoration:line-through;color:blue;">gso_extract_spectrum_with_gti.sh</span><span style="color:red;">hsGSOExtractSpectrumWithGTI</span>

if [ _$4 = _ ];
then
cat &lt;&lt; EOF
usage :
<span style="text-decoration:line-through;color:blue;">gso_lightcurve_correct_deadtime_and_nxb.sh</span><span style="color:red;">hsGSOCorrectLightcurveWithDeadtimeAndNXB</span> (event lightcurve file) (nxb lightcurve file) (pseudo lightcurve file) (output filename prefix) (ehk file; optional) (output plot prefix; optional)

note : output files will be created like (output file prefix).pdf and (output file prefix).lc.
If (output plot prefix) is specified, plots are saved as (output plot prefix).pdf.
EOF
exit
fi

################################
#parameter set
################################
evtlc=$1
nxblc=$2
pselc=$3
outputprefix=$4
outputdir=`dirname $4`
if [ _$5 = _none ];
then
 ehkfile=&quot;none&quot;
else
 ehkfile=$5
fi
if [ _$6 = _ ];
then
outputplotprefix=$outputprefix
else
outputplotprefix=$6
fi

#get pha min max from evtlc
phalowcut=`<span style="text-decoration:line-through;color:blue;">getheader.sh</span><span style="color:red;">hsFitsGetHeader</span> ${evtlc} 1 phalcut`
phahighcut=`<span style="text-decoration:line-through;color:blue;">getheader.sh</span><span style="color:red;">hsFitsGetHeader</span> ${evtlc} 1 phahcut`
energy_lowcut=`<span style="text-decoration:line-through;color:blue;">gso_pi_to_energy.rb</span><span style="color:red;">hsGSOPIToEnergy</span> $phalowcut`
energy_highcut=`<span style="text-decoration:line-through;color:blue;">gso_pi_to_energy.rb</span><span style="color:red;">hsGSOPIToEnergy</span> $phahighcut`

#log file
logfile=${outputprefix}.log
tmp=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`
tmpoutfile=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`

################################
#execution
################################
export PGPLOT_TYPE=&quot;/null&quot; 
rm -f $logfile

#output files
evtlc_dtcor=${outputprefix}_evt_dtcor.lc
nxblc_dtcor=${outputprefix}_nxb_dtcor.lc
evt_sub_nxb=${outputprefix}_corrected_for_dt_nxb.lc
evt_sub_nxb_ps=${outputplotprefix}_corrected_for_dt_nxb.ps
evt_sub_nxb_pco=${outputplotprefix}_corrected_for_dt_nxb.pco
evt_sub_nxb_qdp=${outputplotprefix}_corrected_for_dt_nxb.qdp
evt_sub_nxb_qdppco=${outputplotprefix}_corrected_for_dt_nxb

#temporary files
pselc1_4=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`
tmpqdp=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`.qdp
localqdppco=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`

#cleanup
rm -f ${evt_sub_nxb} ${pselc1_4}
rm -f $evt_sub_nxb_pco $evt_sub_nxb_qdp
<span style="text-decoration:line-through;color:blue;">delete_qdp_files.sh</span><span style="color:red;">hsQDPDeleteQDPFiles</span> $evt_sub_nxb_qdp
<span style="text-decoration:line-through;color:blue;">delete_qdp_files.sh</span><span style="color:red;">hsQDPDeleteQDPFiles</span> $evt_sub_nxb_qdppco 

#do
cp $evtlc ${evtlc_dtcor}
cp $nxblc ${nxblc_dtcor}
echo &quot;PSEUDO/4&quot; 2&gt;&amp;1 | tee -a $logfile
fcalc ${pselc}+1 ${pselc1_4} DTCOR  &quot;RATE/4&quot; clobber=yes 2&gt;&amp;1 | tee -a $logfile
#add DTCOR column to evt_lc
faddcol ${evtlc_dtcor}+1 ${pselc1_4}+1 DTCOR 2&gt;&amp;1 | tee -a $logfile
#nxb is also needed to be corrected for dead-time 
faddcol ${nxblc_dtcor}+1 ${pselc1_4}+1 DTCOR 2&gt;&amp;1 | tee -a $logfile

echo &quot;RATE/(PSEUDO/4)&quot; 2&gt;&amp;1 | tee -a $logfile
#evt
fcalc ${evtlc_dtcor}+1 ${evtlc_dtcor} RATE &quot;RATE/DTCOR&quot; clobber=yes 2&gt;&amp;1 | tee -a $logfile
fcalc ${evtlc_dtcor}+1 ${evtlc_dtcor} ERROR &quot;ERROR/DTCOR&quot; clobber=yes 2&gt;&amp;1 | tee -a $logfile
#nxb
fcalc ${nxblc_dtcor}+1 ${nxblc_dtcor} RATE &quot;RATE/DTCOR&quot; clobber=yes 2&gt;&amp;1 | tee -a $logfile
fcalc ${nxblc_dtcor}+1 ${nxblc_dtcor} ERROR &quot;ERROR/DTCOR&quot; clobber=yes 2&gt;&amp;1 | tee -a $logfile

echo &quot;lcmath&quot; 2&gt;&amp;1 | tee -a $logfile
rm -f $evt_sub_nxb
lcmath ${evtlc_dtcor} ${nxblc_dtcor} ${evt_sub_nxb} multi=1 multb=1 addsubr=no 2&gt;&amp;1 | tee -a $logfile


max=`<span style="text-decoration:line-through;color:blue;">fits_get_maximum_column_value.sh</span><span style="color:red;">hsFitsColumnGetMaximumValue</span> ${evtlc_dtcor} 1 RATE`
ymax=`calc $max*1.5`
tstart=`<span style="text-decoration:line-through;color:blue;">getheader.sh</span><span style="color:red;">hsFitsGetHeader</span> ${evtlc_dtcor} 1 TSTART`
binsize=`<span style="text-decoration:line-through;color:blue;">getheader.sh</span><span style="color:red;">hsFitsGetHeader</span> ${evtlc_dtcor} 1 TIMEDEL`

cat &lt;&lt; EOF &gt; $tmpqdp
SKIP SING
READ SERR 2
!
EOF
<span style="text-decoration:line-through;color:blue;">fits_dump_columns.sh</span><span style="color:red;">hsFitsDumpColumns</span> ${evtlc_dtcor} 1 TIME,RATE,ERROR &gt;&gt; $tmpqdp
echo &quot;NO NO NO&quot; &gt;&gt; $tmpqdp
<span style="text-decoration:line-through;color:blue;">fits_dump_columns.sh</span><span style="color:red;">hsFitsDumpColumns</span> ${nxblc_dtcor} 1 TIME,RATE,ERROR &gt;&gt; $tmpqdp
echo &quot;NO NO NO&quot; &gt;&gt; $tmpqdp
<span style="text-decoration:line-through;color:blue;">fits_dump_columns.sh</span><span style="color:red;">hsFitsDumpColumns</span> ${evt_sub_nxb} 1 TIME,RATE,ERROR &gt;&gt; $tmpqdp
echo &quot;NO NO NO&quot; &gt;&gt; $tmpqdp

#create qdp for a plot without saa nor cor
echo &quot;#1 $tmpqdp&quot;
qdp $tmpqdp &lt;&lt; EOF 2&gt;&amp;1 | tee -a $logfile
win all
fo ro
yplot 1 2 3
view .1 .1
loc 0 0.301999986 1 0.899999976
r y 0 $ymax
cs 1.3
lwidth 3
lwidth 3 on 1..50
lwidth 3
lwidth 3 on 1..50
lab nx on
la t 
la f `<span style="text-decoration:line-through;color:blue;">targetname.sh</span><span style="color:red;">hsFitsGetTargetName</span> ${evtlc_dtcor}` / $binsize s bin / ${energy_lowcut}-${energy_highcut} keV 
lab x TIME s since `<span style="text-decoration:line-through;color:blue;">suzaku_missiontime_to_utc.sh</span><span style="color:red;">hsSuzakuMissionTimeToUTC</span> $tstart`
lab y Count s\u-1\d 
r y 0 $ymax
cs 1.3
lwidth 3
lwidth 3 on 1..50
lwidth 3
lwidth 3 on 1..50
mark 17 on 1
mark 17 on 2
mark 17 on 3
col 1 on 1
col 2 on 2
col 3 on 3
la 1 &quot;
la 2 &quot;
lab 10 pos 10000 `calc $ymax*0.87` col 1 &quot;ALL&quot;
lab 20 pos 10000 `calc $ymax*0.80` col 2 &quot;NXB&quot;
lab 30 pos 10000 `calc $ymax*0.73` col 3 &quot;ALL-NXB&quot;
hard ${evt_sub_nxb_ps}/cps
we ${evt_sub_nxb_qdppco}
we ${localqdppco}
we $tmpqdp
exit

EOF
cd `dirname ${evt_sub_nxb_ps}` &amp;&gt; /dev/null
ps2pdf `basename ${evt_sub_nxb_ps}`
cd -

#cor,saa plot
if [ _$ehkfile != _ ];
then
<span style="text-decoration:line-through;color:blue;">pin_extract_lightcurve_of_cor_and_saa.sh</span><span style="color:red;">hsPINExtractLightcurveOfCORAndSAA</span> $ehkfile $outputprefix
#this script creates files below:
#${outputprefix}_cor.lc
#${outputprefix}_saa.lc
fi

##get xmin xmax using qdp
tmplog=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`
echo &quot;#2 $evt_sub_nxb_qdppco&quot;
qdp $evt_sub_nxb_qdppco &lt;&lt; EOF &gt; $tmplog
/xw
info
exit
EOF

tstart=`<span style="text-decoration:line-through;color:blue;">getheader.sh</span><span style="color:red;">hsFitsGetHeader</span> $evtlc 1 tstart`
tstop=`<span style="text-decoration:line-through;color:blue;">getheader.sh</span><span style="color:red;">hsFitsGetHeader</span> $evtlc 1 tstop`
min=0
max=`calc &quot;$tstop-$tstart&quot;`

offset=`calc &quot;($max-$min)/100*3&quot;`
min=`calc $min-$offset`
max=`calc $max+$offset`
rxminmax=&quot;r x $min $max&quot;
rm $tmplog

##qdp edit
<span style="text-decoration:line-through;color:blue;">fits_dump_columns.sh</span><span style="color:red;">hsFitsDumpColumns</span> ${outputprefix}_cor.lc 1 TIME,COR | awk &quot;{print \$1-`<span style="text-decoration:line-through;color:blue;">getheader.sh</span><span style="color:red;">hsFitsGetHeader</span> ${evt_sub_nxb} 1 TSTART`,\$2,0}&quot; &gt; ${outputplotprefix}_cor.qdp
<span style="text-decoration:line-through;color:blue;">fits_dump_columns.sh</span><span style="color:red;">hsFitsDumpColumns</span> ${outputprefix}_saa.lc 1 TIME,SAA_HXD | awk &quot;{print \$1-`<span style="text-decoration:line-through;color:blue;">getheader.sh</span><span style="color:red;">hsFitsGetHeader</span> ${evt_sub_nxb} 1 TSTART`,\$2,0}&quot; &gt; ${outputplotprefix}_saa.qdp

cat &lt;&lt; EOF &gt;&gt; ${tmpqdp}
NO NO NO
READ SERR 8 9
EOF
cat ${outputplotprefix}_saa.qdp &gt;&gt; ${tmpqdp}
cat &lt;&lt; EOF &gt;&gt; ${tmpqdp}
NO NO NO
READ SERR 15 16
EOF
cat ${outputplotprefix}_cor.qdp &gt;&gt; ${tmpqdp}

##execute qdp
rm -f ${outputplotprefix}_with_saa_cor.ps
rm -f ${outputplotprefix}_with_saa_cor.qdp ${outputprefix}_with_saa_cor.pco
qdp ${tmpqdp} &lt;&lt; EOF
/xw
ti of
@${localqdppco}.pco

win 3
yplot 5
col 15 on 5
line on 5
$rxminmax
view 0 0 1 1
loc .1 .1 .9 .2
la y COR
lab x TIME s since `<span style="text-decoration:line-through;color:blue;">suzaku_missiontime_to_utc.sh</span><span style="color:red;">hsSuzakuMissionTimeToUTC</span> $tstart`

win 2
$rxminmax
yplot 4
line on 4
col 8 on 4
la nx off
view 0 0 1 1
loc .1 .2 .9 .3
la y SAA

win 1
yplot 1 2 3
col 1 on 1
col 2 on 2
col 3 on 3
$rxminmax
la nx off
view 0 0 1 1
loc .1 .3 .9 .9
lab y1 Count s\u-1\d 
r y1 0 $ymax
r y 0 $ymax

win all
plot
hard ${outputplotprefix}_with_saa_cor.ps/cps
we ${outputplotprefix}_with_saa_cor
exit
EOF

cd `dirname ${evt_sub_nxb_ps}` &amp;&gt; /dev/null
ps2pdf `basename ${outputprefix}_with_saa_cor.ps`
cd -


#cleaning again
rm -f $tmp ${tmpoutfile}*
rm -f ${pselc1_4} ${tmpqdp}.qdp ${tmpqdp}.pco $localqdppco

################################
#log
################################
</pre>
</body>
</html>
