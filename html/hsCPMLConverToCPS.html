<html>
<body>
<pre>
#!/usr/bin/env ruby

#20140212 Takayuki Yuasa
#20140217 Takayuki Yuasa first release to HXI/SGD teams
#20140224 Takayuki Yuasa header generation functionality was added

# Section separator
$sectionSeparator=&quot;#==================================================================&quot;
$subsectionSeparator=&quot;#-----------------------------------------------&quot;

# Global variables
$sectionCounter=0

#  Note that $sectionCounter can be changed on-the-fly by doing e.g.
#  @@ set sectionCounter 5
#  in the source file.
$subsectionCounter=1
$lineNumber=1
$stopper=&quot; &quot;
$processingBlockOfCheckCommands=false
$generateCheckSheetTable=true
$resultingCommandSequence=[]
$outputFileName=&quot;&quot;

# Constants
$satelliteName=&quot;ASTRO-H&quot;
$satelliteNumber=&quot;47&quot;
MaximumLengthOfDCSM=1000

class CPSGenerator
def stripLeadingComma(line)
	line=line.strip()
	while(line[0]==&quot;.&quot;)do
		line=line[1...(line.length)].strip()
	end
	return line.strip()
end

def stripLeadingAndTrailingEquals(line)
	line=line.strip()
	while(line[0]==&quot;=&quot;)do
		line=line[1...(line.length)].strip()
	end
	while(line[-1]==&quot;=&quot;)do
		line=line[0...(line.length-1)].strip()
	end
	return line.strip()
end

def expandUserDefinedVariables(str)
	$userDefinedVariables.each(){|key,value|
		str.gsub!(&quot;${#{key}}&quot;,value)
	}
	return str
end

def constructAndGetHeader()
	result=&quot;&quot;
	#2013-12-25 10:03:19
	dateTime=Time.now.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;)
	nLines=$resultingCommandSequence.length()
	if($outputFileName==&quot;&quot;)then
		result=&quot;# Warning: MAIN/DCSM header was not automatically generated because &#39;outputFileName&#39; is not set in CPML.&quot;
	else
		array=$outputFileName.split(&quot;.&quot;)
		basename=array[0...(array.length-1)].join(&quot;.&quot;)
		if($outputFileName.downcase.include?(&quot;main&quot;))then #main
			result=&quot;#!HEAD: #{basename} #{dateTime} #{nLines} #{$satelliteNumber} #{$satelliteName} MAIN2 //    #&quot;
		elsif($outputFileName.downcase.include?(&quot;dcsm&quot;))then #dcsm
			# something like
			# #!HEAD: dcsm-CAMS1-AlignmentTestExtraSteps 2013-12-25 10:07:22 866 47 ASTRO-H DCSM
			result=&quot;#!HEAD: #{basename} #{dateTime} #{nLines} #{$satelliteNumber} #{$satelliteName} DCSM //    #&quot;
		else
			result=&quot;# Warning: MAIN/DCSM header was not automatically generated because &#39;outputFileName&#39; does not include &#39;main-&#39; or &#39;dcsm-&#39;&quot;
		end
	end
	return result+&quot;\n&quot;
end

def getResultingCommandSequence()
	return $resultingCommandSequence.join(&quot;\n&quot;).gsub!(/\n\n/,&quot;\n&quot;)
end
def output()
	if($outputFileName==&quot;&quot;)then
		puts constructAndGetHeader()
		puts getResultingCommandSequence()
	else
		STDERR.puts &quot;Saving to #{$outputFileName}&quot;
		file=open($outputFileName,&quot;w&quot;)
		file.write(constructAndGetHeader())
		file.write(getResultingCommandSequence())
		file.close()
		if($outputFileName.downcase.include?(&quot;dcsm&quot;))then
			nLines=$resultingCommandSequence.length
			if(nLines&gt;MaximumLengthOfDCSM)then
				STDERR.puts &quot;Warning: The generated DCSM is longer than 1000 lines (#{nLines} lines) which is the limit for one DCSM file.&quot;
			end
		end
	end
end

def dump(str)
	str.each_line(){|line|
		line = expandUserDefinedVariables(line)
		$resultingCommandSequence &lt;&lt; &quot;#{&quot;%04d&quot; % $lineNumber}  #{$stopper} #{line}&quot;
		$lineNumber=$lineNumber+1
	}
end

def dumpWithComma(str)
	str.each_line(){|line|
		line = expandUserDefinedVariables(line)
		$resultingCommandSequence &lt;&lt; &quot;#{&quot;%04d&quot; % $lineNumber}  . #{line}&quot;
		$lineNumber=$lineNumber+1
	}
end

def processSectionHeader(line)
	$sectionCounter=$sectionCounter+1
	$subsectionCounter=1
	sectionNumber = &quot;#{$sectionCounter}.&quot;
	title=stripLeadingAndTrailingEquals(line)
	dump $sectionSeparator
	dumpWithComma &quot;# #{sectionNumber} #{title}&quot;
	dump $sectionSeparator
end

def processSubsectionHeader(line)
	sectionNumber = &quot;#{$sectionCounter}.#{$subsectionCounter}.&quot;
	title=stripLeadingAndTrailingEquals(line)
	dump $subsectionSeparator
	dumpWithComma &quot;# #{sectionNumber} #{title}&quot;
	dump $subsectionSeparator
	$subsectionCounter=$subsectionCounter+1
end

def processComment(line)
	if(line[0..1]!=&quot;# &quot;)then
		line=line[1...(line.length)]
		dump &quot;# #{line}&quot;
	else
		dump line
	end
end

$blockOfCheckCommands=[]
$blockOfCheckCommandsStoppers=[]

def dumpTelemetryCheckSheetTable()
	if($generateCheckSheetTable)then
		dump &lt;&lt;EOS
#
# -------------------------+-----------------+-----------+---------
# #{&quot;%25s&quot;%&quot;Attribute&quot;.ljust(25)} #{&quot;%17s&quot;%&quot;Predict&quot;.center(17)} #{&quot;%11s&quot;%&quot;Data&quot;.center(11)}  Result
# -------------------------+-----------------+-----------+---------
EOS
	
		$blockOfCheckCommands.each(){|line|
		if(!line.include?(&quot;CHECK &quot;))then
			#this might be SYSTEM or other non-CHECK commands,
			#and then, just continue the loop.
			next
		end
		array=line.split(&quot; &quot;)
		attributePath=array[1]
		attributeName=attributePath.split(&quot;.&quot;)[-1]

		expectedValue=&quot;???&quot;
		dataInputForm=&quot;___________&quot;
		if(line.include?(&quot;=&quot;))then
			expectedValue=line.split(&quot;=&quot;)[-1]
			dataInputForm=&quot;___________&quot;
		elsif(line.include?(&quot;updatewait&quot;))then
			expectedValue=&quot;updated&quot;
			dataInputForm=&quot;____-&gt;_____&quot;
		else
			if(array[2]!=nil)then
				expectedValue=array[2...(array.length)].join(&quot; &quot;)
			else
				putsError &quot;No expected value provided to a CHECK command.&quot;
			end
		end
		

		dump &lt;&lt;EOS % [attributeName, expectedValue.center(17), dataInputForm]
# %-25s %17s %s Pass/Fail
EOS
	}	
		dump &quot;#&quot;
	else
		#if $generateCheckSheetTable is false, then
		#just return.
		return
	end
end

def dumpTelemetryCheckOverallResult()
	if(!$generateCheckSheetTable)then
		return
	end
	dump &lt;&lt;EOS
#                                   Overall check result: Pass/Fail
#
EOS
end

def dumpBlockOfCheckCommands()
	stopperRegistered=$stopper
	$stopper=&quot; &quot;
	if($blockOfCheckCommands.length==0)then
		return
	end
	
	#dumps check table
	dumpTelemetryCheckSheetTable()

	#dumps check commands themselves
	str=&quot;&quot;
	$blockOfCheckCommands.each_with_index(){|e,i|
		$stopper=$blockOfCheckCommandsStoppers[i]
		dump &lt;&lt;EOS
#{$blockOfCheckCommands[i]}
EOS
	}

	#dump overall check
	dumpTelemetryCheckOverallResult()

	$blockOfCheckCommands=[]
	$processingBlockOfCheckCommands=false
	$stopper=stopperRegistered
end

def processCommandExecution(line)
	if(line.index(&quot;SYSTEM &quot;)==0)then
		#if SYSTEM command appears inside a block of CHECK commands,
		#it should be dumped together with those CHECK commands.
		if($processingBlockOfCheckCommands)then
			$blockOfCheckCommands &lt;&lt; line
		else
			dump line
		end
	elsif(line.index(&quot;CHECK &quot;)==0)then
		#if check command, automatically generate a table
		$processingBlockOfCheckCommands=true
		$blockOfCheckCommands &lt;&lt; line
		$blockOfCheckCommandsStoppers &lt;&lt; $stopper
	else
		#this means an end of a block of check commands,
		#and therefore, dumps check table and check
		#commands themselves.
		if($processingBlockOfCheckCommands)then
			dumpBlockOfCheckCommands()
		end
		dump line
	end
end

def processMetaCommand(line)
	line.gsub!(&quot;@@&quot;,&quot;&quot;).strip!()
	array=line.split(&quot; &quot;)
	if(array.length==0)then
		return
	end
	command=array[0]

	#puts &quot;MetaCommand = #{command}&quot;

	if(command==&quot;set&quot;)then
		processMetaCommandSet(array[1...(array.length)])
	elsif(command==&quot;import&quot; or command==&quot;include&quot;)then
		if(array[1]==nil)then
			putsError &quot;@@ import command requires file name.&quot;
		end
		fileName=array[1].gsub(&#39;&quot;&#39;,&quot;&quot;)
		processMetaCommandImport(fileName)
	elsif(command==&quot;require&quot;)then
		if(array[1]==nil)then
			putsError &quot;@@ require command requires variable name.&quot;
		end
		variableName=array[1].to_s
		#check if a necessary user-defined command is already defined.
		if($userDefinedVariables[variableName]==nil)then
			putsError &quot;User-defined variable #{variableName} is not defined, and @@ require command failed.&quot;
		end
	end

end

def processLine(lineString)
	line=lineString.strip()
	
	if(line.include?(&quot;//&quot;))then
		dumpBlockOfCheckCommands()
		return
	elsif(line.include?(&quot;@@&quot;))then
		dumpBlockOfCheckCommands()
		processMetaCommand(line)
	elsif(line.include?(&quot;===&quot;))then
		dumpBlockOfCheckCommands()
		processSubsectionHeader(line)
	elsif(line.include?(&quot;==&quot;))then
		dumpBlockOfCheckCommands()
		processSectionHeader(line)
	elsif(line[0]==&quot;#&quot;)then
		dumpBlockOfCheckCommands()
		processComment(line)
	elsif(line.gsub(&quot; &quot;,&quot;&quot;)[1]==&quot;#&quot;)then
		dumpBlockOfCheckCommands()
		$stopper=&quot;.&quot;
		line=stripLeadingComma(line)
		processComment(line)
		$stopper=&quot; &quot;
	elsif(line[0]==&quot;.&quot;)then
		$stopper=&quot;.&quot;
		line=stripLeadingComma(line)
		processCommandExecution(line)
		$stopper=&quot; &quot;
	elsif(line.length!=0)then
		processCommandExecution(line)
	else #if line==&quot;&quot;
		dumpBlockOfCheckCommands()
		processComment(&quot;#&quot;)
	end

end

def processMetaCommandImport(fileName)
	if(!File.exist?(fileName))then
		putsError &quot;@@ import cannot find a file named #{fileName}.&quot;
	end
	open(fileName).each(){|line|
		processLine(line)
	}
	dumpBlockOfCheckCommands()
end

$userDefinedVariables={}

def processMetaCommandSet(array)
	if(array.length&lt;2)then
		putsError &quot;@@ set requires variable name and value.&quot;
	end
	variableName=array[0]
	value=expandUserDefinedVariables(array[1].to_s)

	#puts &quot;processMetaCommandSet #{array[0]} #{array[1]}&quot;

	if(variableName==&quot;sectionCounter&quot;)then
		$sectionCounter=value.to_i
	elsif(variableName==&quot;generateCheckSheetTable&quot;)then
		if(value.to_s==&quot;true&quot; or value.to_s==&quot;yes&quot;)then
			#STDERR.puts &quot;CheckSheet generation is turned on.&quot;
			$generateCheckSheetTable=true
		elsif(value.to_s==&quot;false&quot; or value.to_s==&quot;no&quot;)then
			#STDERR.puts &quot;CheckSheet generation is turned off.&quot;
			$generateCheckSheetTable=false
		else
			putsError &quot;generateCheckSheetTable should be either of true/false (or yes/no). #{value} was provided.&quot;
		end
	elsif(variableName==&quot;lineNumber&quot;)then
		$lineNumber=value.to_i
	elsif(variableName==&quot;outputFileName&quot;)then
		$outputFileName=value
	else
		#user-defined variable
		$userDefinedVariables[variableName]=value.to_s
		#puts &quot;UserDefinedValue added: #{variableName} = #{value.to_s}&quot;
	end

end

def processFile(fileName)
	open(fileName).each(){|line|
		processLine(line)
	}
	dumpBlockOfCheckCommands()
	processLine(&quot;#&quot;)
	processLine(&quot;# End of file&quot;)
end

def putsError(str)
	#todo: implement filename and line number of error
	STDERR.puts &quot;Error: #{str}&quot;
	exit
end
end #end of class definition

# Sample of the header
# MAIN
# #!HEAD: main2-CAMS1_EICMIC 2013-12-25 10:03:19 302 47 ASTRO-H MAIN2 //    #
# DCSM (subroutine; stands for Discrete Command and Serial Magnitude command)
# #!HEAD: dcsm-CAMS1-AlignmentTestExtraSteps 2013-12-25 10:07:22 866 47 ASTRO-H DCSM

# Sample of check-sheet table
# -------------------------+-----------------+-----------+---------
# Attribute                 Predict           Data        Result
# -------------------------+-----------------+-----------+---------
# CMD_RCV_COUNT              +1               ____-&gt;_____ Pass/Fail
# IS_SAMPLING                Sampling         ____________Pass/Fail

#---------------------------------------------
# Main routine
#---------------------------------------------
if (ARGV.length==0) then
	STDERR.puts &quot;provide input file name&quot;
	exit
end
inputFile=ARGV[0]
generator=CPSGenerator.new
generator.processFile(inputFile)
generator.output()
</pre>
</body>
</html>
