<html>
<body>
<pre>
#!/bin/bash

#20100803 Takayuki Yuasa

if [ _$1 = _ ]; then
cat &lt;&lt; EOF 1&gt;&amp;2
usage : `basename $0` (output folder name) (analysis folder1) (tag of flattened image1) ... (analysis folderN) (tag of flattened imageN)
 output folder name : the folder where output should be saved
 analysis folder? : folder name of the analysis folder containing flattened images
 tag of flattened image? : tag of the flattened image

example : `basename $0` mosaic 502002010 cleanedevent 502003010 cleanedevent

This script creates a mosaic image of the XIS data of
multiple observations. Each image should be created
using <span style="text-decoration:line-through;color:blue;">xis_create_flatimage.sh</span><span style="color:red;">hsXISCreateFlatImage</span> in HongoScript style
analysis folders (e.g. target/analysis/xis/image_analysis/flattened_images/).

EOF
exit -1
fi

#temporary file
tmp_folderlist=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`

#construct script
ruby &lt;&lt; EOF
require &quot;fileutils&quot;
line=&quot;$@&quot;
array=line.split(&quot; &quot;)
if((array.length-1)%2!=0)then
exit -1
end

outputfolder=array[0]

if(!FileTest.exist?(outputfolder))then
print &quot;Output folder was newly created...\n&quot;
FileUtils.mkdir(outputfolder)
end

i=1
file=File.open(&quot;$tmp_folderlist&quot;,&quot;w&quot;)

while i&lt;array.length do
name=array[i]
tag=array[i+1]
i=i+2

file.puts &quot;#{name}/analysis/xis/image_analysis/flattened_images/#{tag}/\n&quot;

end

file.close
EOF


#function
function deleteTemporaryFilesThenExit() {
for file in $tmp_folderlist $tmp_sources $tmp_nxbs $tmp_flats $tmp_expmaps $tmp_trims $tmp0 $tmp1 $tmp2 $tmp3 $tmp4 $tmp5 $tmp6 $tmp_sources_count $mosaiclist; do
if [ -f $file ]; then
rm -f $file
fi
if [ -f ${file}_mosaic_command ]; then
rm -f ${file}_mosaic_command
fi
done
echo &quot;Exitting...&quot;
exit -1
}

#check output script
if [ ! -f $tmp_folderlist ]; then
echo &quot;Argument number error...&quot; 1&gt;&amp;2
echo &quot;Please see help invoking `basename $0` with no argument.&quot; 1&gt;&amp;2
deleteTemporaryFilesThenExit
fi

outputfolder=$1

#search files
echo &quot;Searching files to be used to create a mosaic image...&quot;
tmp_sources=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`_sources
tmp_nxbs=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`_nxbs
tmp_flats=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`_flats
tmp_expmaps=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`_expmaps
tmp_trims=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`_trims
touch $tmp_sources $tmp_nxbs $tmp_flats $tmp_expmaps $tmp_trims
for path in `cat $tmp_folderlist`; do
ls $path/xis?_flattened.img 2&gt; /dev/null &gt;&gt; $tmp_sources
ls $path/nxbimages/xis?_nxb_binned.img 2&gt; /dev/null &gt;&gt; $tmp_nxbs
ls $path/flatimages/xis?_flat_smoothed_normalized.img 2&gt; /dev/null &gt;&gt; $tmp_flats
ls $path/exposuremaps/xis?_expmap_binned.img 2&gt; /dev/null &gt;&gt; $tmp_expmaps
ls $path/exposuremaps/xis?_trim.img 2&gt; /dev/null &gt;&gt; $tmp_trims
done

echo &quot;Validating files...&quot;
for file in $tmp_sources $tmp_nxbs $tmp_expmaps $tmp_trims;do
if [ `<span style="text-decoration:line-through;color:blue;">file_linenumber.sh</span><span style="color:red;">hsFileCountLineNumber</span> $file` = 0 ]; then
if [ $file = $tmp_sources ]; then
echo &quot;Source file is missing...&quot;
fi
if [ $file = $tmp_nxbs ]; then
echo &quot;NXB file is missing...&quot;
fi
if [ $file = $tmp_expmap ]; then
echo &quot;Exposure map file is missing...&quot;
fi
if [ $file = $tmp_trims ]; then
echo &quot;Trimming mask file is missing...&quot;
fi
deleteTemporaryFilesThenExit
fi
done


#calculate mosaic size
echo &quot;Automatically calculating the mosaic size...&quot;
sourcelist=`cat $tmp_sources`
mosaicsizeandcenter=`<span style="text-decoration:line-through;color:blue;">xis_calculate_mosaic_image_size.rb</span><span style="color:red;">hsXISCalculateMosaicImageSize</span> $sourcelist`
mosaicsize=`echo &quot;$mosaicsizeandcenter&quot; | awk &#39;{print \$1}&#39;`
mosaiccenter=`echo &quot;$mosaicsizeandcenter&quot; | awk &#39;{print \$2}&#39;`
echo &quot;Mosaic size is $mosaicsize&quot;
echo &quot;Mosaic center is $mosaiccenter&quot;

#list of mosaic images
mosaiclist=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`_mosaiclist
touch $mosaiclist

#create folder
relatedfilefolder=$outputfolder/realted
if [ ! -d $relatedfilefolder ]; then
mkdir -p $relatedfilefolder
fi

#create source mosaics (in counts/binned pixel)
tmp_sources_count=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`_sources_count
touch $tmp_sources_count
i=0
centerimage=&quot;&quot;
for file in `cat $tmp_sources`;do
echo &quot;File:$file&quot;
exposure=`<span style="text-decoration:line-through;color:blue;">exposure.sh</span><span style="color:red;">hsGetFitsExposure</span> $file`
echo &quot;Exposure:$exposure&quot;
naxis1=`<span style="text-decoration:line-through;color:blue;">getheader.sh</span><span style="color:red;">hsFitsGetHeader</span> $file 0 naxis1`
echo &quot;NAXIS1=$naxis1&quot;
binning=`calc &quot;1536/$naxis1&quot;`
echo &quot;Binning:$binning&quot;
scaling=`perl -e &quot;print $exposure*$binning*$binning&quot;`
echo &quot;Scaling:$scaling&quot;
tmp=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`.img
echo &quot;Processing $file&quot;
i=`calc $i+1`
ximage &lt;&lt; EOF &amp;&gt; /dev/null &amp;
read/fits $file
rescale/multiply
$scaling
save_image
write_image/fits $relatedfilefolder/$tmp
exit
EOF
if [ $mosaiccenter = $file ]; then
 centerimage=$relatedfilefolder/$tmp
else
 echo $relatedfilefolder/$tmp &gt;&gt; $tmp_sources_count
fi
if [ $i = 2 ]; then
wait
i=0
fi
done

wait

#find center expmap and trim mask
mosaiccenter_fullpath=`fullpath $mosaiccenter`
mosaiccenter_dirname=`dirname $mosaiccenter_fullpath`
expmapcenter=`ls $mosaiccenter_dirname/exposuremaps/xis?_expmap_binned.img 2&gt; /dev/null | tail -1`
if [ _$expmapcenter = _ ]; then
echo &quot;Exposure map file for the center image is missing...&quot; 1&gt;&amp;2
deleteTemporaryFilesThenExit
else
expmapcenter=`fullpath $expmapcenter`
fi
tmp=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`
echo $expmapcenter &gt; $tmp
for file in `cat $tmp_expmaps`; do
if [ `fullpath $file` != $expmapcenter ]; then
echo $file &gt;&gt; $tmp
fi
done
mv $tmp $tmp_expmaps

trimcenter=`ls $mosaiccenter_dirname/exposuremaps/xis?_trim.img 2&gt; /dev/null | tail -1`
if [ _$trimcenter = _ ]; then
echo &quot;Trim mask file for the center image is missing...&quot; 1&gt;&amp;2
deleteTemporaryFilesThenExit
else
trimcenter=`fullpath $trimcenter`
fi
tmp=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`
echo $trimcenter &gt; $tmp
for file in `cat $tmp_trims`; do
if [ `fullpath $file` != $trimcenter ]; then
echo $file &gt;&gt; $tmp
fi
done
mv $tmp $tmp_trims


#create source mosaic
commandfile=${tmp_sources_count}_mosaic_command
mosaic=${tmp_sources_count}_mosaic.img
<span style="text-decoration:line-through;color:blue;">ximage_create_commands_for_mosaic.sh</span><span style="color:red;">hsFtoolsXimageCreateCommandsForMosaicing</span> $mosaicsize $centerimage `cat $tmp_sources_count` | sed -e &quot;s/^disp//g&quot; &gt; $commandfile
cat &lt;&lt; EOF &gt;&gt; $commandfile
write_image/fits $mosaic
exit
EOF
echo &quot;Creating a mosaic of source images...&quot;
ximage &lt; $commandfile &amp;&gt; /dev/null &amp;
echo &quot;$mosaic&quot; &gt;&gt; $mosaiclist


#create exposure map mosaic
for file in $tmp_expmaps $tmp_trims; do
 commandfile=${file}_mosaic_command
 mosaic=${file}_mosaic.img
 <span style="text-decoration:line-through;color:blue;">ximage_create_commands_for_mosaic.sh</span><span style="color:red;">hsFtoolsXimageCreateCommandsForMosaicing</span> $mosaicsize `cat $file` | sed -e &quot;s/^disp//g&quot; &gt; $commandfile
# if [ _`echo &quot;$file&quot; | grep expmap` != _ ]; then
#  tmp=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`
#  sed -e &#39;s/.img$/.img\+1/g&#39; $commandfile &gt; $tmp
#  mv $tmp $commandfile
# fi
 cat &lt;&lt; EOF &gt;&gt; $commandfile
write_image/fits $mosaic
exit
EOF
 echo &quot;Creating a mosaic of `echo $file | awk -F_ &#39;{print \$3}&#39;`...&quot;
 ximage &lt; $commandfile &amp;&gt; /dev/null &amp;
 echo &quot;$mosaic&quot; &gt;&gt; $mosaiclist
done

wait

#delete temporary files
for file in `cat $tmp_sources_count`; do
rm -f $file
done


#check outputs
for file in `cat $mosaiclist`; do
if [ ! -f $file ]; then
echo &quot;Creating individual mosaics failed...&quot; 1&gt;&amp;2
echo &quot;($file was not found...)&quot; 1&gt;&amp;2
deleteTemporaryFilesThenExit
fi
done
echo &quot;Creating individual mosaics done...&quot;


#move files into output
for type in sources expmaps trims; do
tmpfile=`grep $type $mosaiclist | tail -1`
if [ ! -f $tmpfile ]; then
echo &quot;Creating a mosaic failed...&quot; 1&gt;&amp;2
deleteTemporaryFilesThenExit
fi
mv $tmpfile $relatedfilefolder/${type}.img
done


#correct exposure
pushd $relatedfilefolder &amp;&gt; /dev/null
tmp0=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`_tmp0
tmp1=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`_tmp1
tmp2=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`_tmp2
tmp3=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`_tmp3
tmp4=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`_tmp4
tmp5=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`_tmp5
tmp6=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`_tmp6
echo &quot;Correcting exposure...&quot;
farith sources.img[0] expmaps.img[0] $tmp0 DIV
fimgtrim &quot;$tmp0&quot; threshlo=-100 const_lo=0 threshup=100 const_up=0 outfile=$tmp1 &gt; /dev/null
echo &quot;Trimming the sharp edges...&quot;
fimgtrim &quot;trims.img[0]&quot; threshlo=0 const_lo=0 threshup=1 const_up=1 outfile=$tmp2 &gt; /dev/null
farith $tmp1[0] $tmp2 $tmp3 MUL
mv $tmp2 trims.img
fimgtrim &quot;$tmp3[0]&quot; threshlo=-100 const_lo=0 threshup=100 const_up=0 outfile=$tmp4 &gt; /dev/null
if [ ! -f $tmp4 ]; then
echo &quot;Constructing a mosaic failed...&quot; 1&gt;&amp;2
deleteTemporaryFilesThenExit
else
echo &quot;Completed!&quot;
fi
mv $tmp4 ../mosaic.img 
rm -f $tmp1 $tmp2 $tmp3 $tmp4 $tmp5
popd &amp;&gt; /dev/null

#delete temporary file
deleteTemporaryFilesThenExit
</pre>
</body>
</html>
