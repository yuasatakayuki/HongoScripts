<html>
<body>
<pre>
#!/bin/bash

#200904xx Takayuki Yuasa file created
#20090706 Takayuki Yuasa modification for CLI-menu driven structure
#20090713 Takayuki Yuasa band image extraction added
#20100125 Takayuki Yuasa ana/ changed to analysis/

##################################
#VARIABLE DEFINITIONS
##################################
# tag : analysis tag name
# source_regionfile : filename of source region
# bgd_regionfile    : filename of bgd region
# gtifile           : filename of gti

tag=contami1
source_regionfile=contami1.reg
bgd_regionfile=bgd1.reg
tag=cleanedevent
source_regionfile=source_ra_dec_120.reg
bgd_regionfile=bgd1.reg
gtifile=none
extraconditionfile=none


##################################
#CONSTANTS
##################################
true=0
false=254
analysisfolder=&quot;analysis&quot;

##################################
#INITIALIZATION
##################################
if [ _$HS_PDF_VIEWER = _ ];
then
	echo &quot;please set PDF Viewer program name as the environmental variable HS_PDF_VIEWER&quot;
	echo &quot; Example : &quot;
	echo &quot;  MacOS X case&quot;
	echo &quot;    export HS_PDF_VIEWER=open&quot;
	echo &quot;  Linux case&quot;
	echo &quot;    export HS_PDF_VIEWER=xpdf&quot;
	exit
fi

if [ _$1 = _ ];
then
	read -p &quot;input analysis folder name &gt; &quot; ip
	if [ _$ip = _ ];
	then
	echo &quot;source folder name empty...exit&quot;
	exit
	fi
else
	ip=$1
fi

if [ _$ip = _ -o -d $ip ];
then
echo &quot;souce folder is found...OK&quot;
else
echo &quot;souce folder is not found...exit&quot;
exit
fi

topdirectory=`pwd`

##################################
##################################
#SUB ROUTINES BEGINS
##################################

##################################
#confirm to proceed
##################################
confirm(){
	read -p &quot;press enter to go back to the menu...&quot;
}

##################################
#dump funtion status
##################################
function_start(){
	cat &lt;&lt; EOF

*******************************************************************
Function : $functionname starts
*******************************************************************

EOF
}

function_completed(){
	cat &lt;&lt; EOF

*******************************************************************
Function : $functionname completed
*******************************************************************

EOF
}

##################################
#show menu
##################################
show_menu(){
	if [ _${source_regionfile} = _ ];
	then
	 current_source_regionfile=&quot;...yet assigned...&quot;
	else
	 current_source_regionfile=${source_regionfile}
	fi
	if [ _${bgd_regionfile} = _ ];
	then
	 current_bgd_regionfile=&quot;...yet assigned...&quot;
	else
	 current_bgd_regionfile=${bgd_regionfile}
	fi
	if [ _${gtifile} = _ -o _${gtifile} = &quot;_none&quot; ];
	then
	 current_gtifile=&quot;...yet assigned...&quot;
	else
	 current_gtifile=$gtifile
	fi
	if [ _${extraconditionfile} = _ -o _${extraconditionfile} = &quot;_none&quot; ];
	then
	 current_extraconditionfile=&quot;...yet assigned...&quot;
	else
	 current_extraconditionfile=$extraconditionfile
	fi
	
	cat &lt;&lt; EOF
====================================
   XIS Point Source Analysis MENU
====================================
Target Analysis Folder : ${ip}

 --Before Analysis--
 [100] Link Event Files
 
 --Analysis Configuration--
 [200] Set Analysis Tagname 
      Current Tagname = ${tag}
 [210] Set Source/BGD Region Filename
      Current Source = ${current_source_regionfile}
      Current  BGD   = ${current_bgd_regionfile}
 [211] List Region Files (in regions/)
 [220] Set Good Time Interval File
      Current GTI File = ${current_gtifile}
 [230] Extra Condition File
      Current File = ${current_extraconditionfile}
      (this may contain filtering commands for xselect)
 
 --Image Analysis--
 [300] Extract Raw Images
 [301] Check Raw Images
 [302] Create Raw Image PDF 
 [303] Check Raw Image PDF
 [310] Create Source Region File (auto)
 [311] Create Source Region File (manually)
 [312] Create Source Region File (auto, then quit DS9)
 [320] Create BGD Region File (auto)
 [321] Create BGD Region File (manually)
 [322] Create BGD Region File (auto, then quit DS9)
 [330] Extract Filtered Images
 [331] Check Filtered Images
 [340] Extract Band Images
 [341] List Band Images
 [342] Display Band Images
 
 --Spectral Analysis--
 [400] Extract Source/BGD Spectra
 [410] Create Redistribution Matrices
 [411] List Redistribution Matrices
 [420] Create Ancillary Response Files
 [421] List Ancillary Response Files
 [430] Create Spectra Check Plot
 [431] Check Spectra Check Plot
 
 --Temporal Analysis--
 [500] Extract Source/BGD Lightcurves
 [501] List Lightcurve(.lc) Files
 [502] List Lightcurve Plots
 [503] Display Lightcurve Plot
 [510] Calculate Power Spectrum
 [520] Search Periodicity
 [530] Fold Lightcurve
 
 --Quit--
 [999] Quit
 
EOF
}


##################################
#change analysis tagname
##################################
set_analysis_tagname(){
	cat &lt;&lt; EOF
*******************************************************************
                         NOTICE
*******************************************************************
&quot;Analysis Tag&quot; is a name of data set which produced with current
event filtering conditions (like region, GTI, and so on). The tag 
should be simple but self-contained so that you or your colleague 
can know the contents and their filtering conditions easily.
*******************************************************************
EOF
	echo &quot;&quot;
	read -p &quot;input tag name &gt; &quot; tag
}

##################################
#set source/bgd region filenames
##################################
set_regionfilenames(){
	read -p &quot;input source region filename &gt; &quot; source_regionfile
	read -p &quot;then, input background region filename &gt; &quot; bgd_regionfile
	check_regionfile_exsistence
	if [ $? -eq $false ];then
		echo &quot;&quot;
		cat &lt;&lt; EOF
*******************************************************************
                         WARNING
*******************************************************************
It seems that region files designated above do not exist yet.
Please create them using &#39;Create Source Region File&#39; and 
&#39;Create Bgd Region File&#39; commands before starting further analysis.
*******************************************************************
EOF
		echo &quot;&quot;
		confirm
	fi
}

##################################
#list region files
##################################
list_region_files(){
	cd $ip/${analysisfolder}/xis/image_analysis/regions
	regionfiles=`ls -1 *.reg`
	regionfiles_head1=`ls -1 *.reg | head -1`
	cd - &amp;&gt; /dev/null
	if [ _$regionfiles_head1 = _ ];
	then
		echo &quot;there are no region files...&quot;
	else
		echo &quot;image_analysis/regions/ contains...&quot;
		for entry in $regionfiles;
		do
			echo &quot; $entry&quot;
		done
		echo &quot;&quot;
	fi
	confirm
}

##################################
#check if region files exist
##################################
check_regionfile_exsistence(){
	echo &quot;checking region files...&quot;
	if [ _$source_regionfile = _ ];then
		echo &quot; source region file is not set yet...&quot;
		return $false
	fi
	if [ _$bgd_regionfile = _ ];then
		echo &quot; bgd region file is not set yet...&quot;
		return $false
	fi
	
	echo &quot; checking ${ip}/${analysisfolder}/xis/image_analysis/regions/${source_regionfile}...&quot;
	if [ ! -f ${ip}/${analysisfolder}/xis/image_analysis/regions/${source_regionfile} ];then
		echo &quot; file not found...&quot;
		return $false
	else
		echo &quot;  OK&quot;
	fi

	echo &quot; checking ${ip}/${analysisfolder}/xis/image_analysis/regions/${bgd_regionfile}...&quot;
	if [ ! -f ${ip}/${analysisfolder}/xis/image_analysis/regions/${bgd_regionfile} ];then
		echo &quot; file not found...&quot;
		return $false
	else
		echo &quot;  OK&quot;
	fi
	return $true
}

##################################
#set gti filename
##################################
set_gtifilename(){
	read -p &quot;input gti filename &gt; &quot; gtifile
	check_gtifile_exsistence
	if [ $? -eq $false ];then
		echo &quot;&quot;
		cat &lt;&lt; EOF
*******************************************************************
                         WARNING
*******************************************************************
It seems that GTI file designated above do not exist yet.
Please check the filepath or create it before proceeding
event processing.
*******************************************************************
EOF
		echo &quot;&quot;
		confirm
	fi
}

##################################
#check if gti file exist
##################################
check_gtifile_exsistence(){
	echo &quot;checking GTI file...&quot;
	if [ _$gtifile = _ ];then
		echo &quot; GTI file is not set yet...&quot;
		return $false
	fi
	if [ _$gtifile = &quot;_none&quot; ];then
		echo &quot; GTI file is not set yet...&quot;
		return $false
	fi
	
	echo &quot; checking ${gtifile}...&quot;
	if [ ! -f ${gtifile} ];then
		echo &quot; file not found...NG&quot;
		return $false
	else
		echo &quot; GTI file found...OK&quot;
	fi

	return $true
}

##################################
#set extra condition filename
##################################
set_extraconditionfilename(){
	read -p &quot;input extra condition filename &gt; &quot; extraconditionfile
	check_extraconditionfile_exsistence
	if [ $? -eq $false ];then
		echo &quot;&quot;
		cat &lt;&lt; EOF
*******************************************************************
                         WARNING
*******************************************************************
It seems that Extra Condition file designated above do not exist yet.
Please check the filepath or create it before proceeding
event processing.
*******************************************************************
EOF
		echo &quot;&quot;
		confirm
	fi
}

##################################
#check if extra command file exist
##################################
check_extraconditionfile_exsistence(){
	echo &quot;checking Extra Command file...&quot;
	if [ _$extraconditionfile = _ ];then
		echo &quot; Extra Command file is not set yet...&quot;
		return $false
	fi
	if [ _$extraconditionfile = &quot;_non&quot; ];then
		echo &quot; Extra Command file is not set yet...&quot;
		return $false
	fi
	
	echo &quot; checking ${extracommandfile}...&quot;
	if [ ! -f ${extracommandfile} ];then
		echo &quot; file not found...NG&quot;
		return $false
	else
		echo &quot; Extra Command file found...OK&quot;
	fi

	return $true
}



##################################
#link event
##################################
link_event(){
	functionname=&quot;link event&quot;
	function_start
	cd $ip/${analysisfolder}/xis/
	<span style="text-decoration:line-through;color:blue;">xis_link_event.sh</span><span style="color:red;">hsXISLinkEventFiles</span> `ls -d ../../data/?????????`
	cd - &amp;&gt; /dev/null
	function_completed
	confirm
}

##################################
#extract raw images
##################################
extract_raw_images(){
	functionname=&quot;extract raw image&quot;
	function_start
	cd $ip/${analysisfolder}/xis/image_analysis/
	<span style="text-decoration:line-through;color:blue;">xis_extract_raw_images.sh</span><span style="color:red;">hsXISExtractRawImage</span>
	cd - &amp;&gt; /dev/null
	function_completed
	confirm
}

check_raw_images(){
	functionname=&quot;check raw images&quot;
	function_start
	cd $ip/${analysisfolder}/xis/image_analysis/
	if [ -f raw_images/fi_bin2.img -a -f raw_images/bi_bin2.img ];
	then
		ds9 raw_images/fi_bin2.img raw_images/bi_bin2.img -zoom to fit -frame 1 -zoom to fit 
	else
		echo &quot; raw images are not found&quot;
		echo &quot; use this command after extracting raw images&quot;
	fi
	cd - &amp;&gt; /dev/null
	function_completed
	confirm
}

##################################
#create regions
##################################
create_source_region_auto(){
	functionname=&quot;create source region (auto)&quot;
	function_start
	cd $ip/${analysisfolder}/xis/image_analysis/
	if [ ! -f raw_images/fi_bin1.img ];
	then
		echo &quot; needed image file &#39;raw_images/fi_bin1.img&#39; was not found...&quot;
		echo &quot; please execute this command after executing &#39;Extract Raw Images&#39;&quot;
		return
	fi
	read -p &quot;input source region filename to be created &gt; &quot; source_regionfile
	<span style="text-decoration:line-through;color:blue;">xis_create_region_file_for.sh</span><span style="color:red;">hsXISCreateRegionFileFor</span> raw_images/fi_bin1.img regions/${source_regionfile}
	ds9 raw_images/fi_bin1.img -region regions/${source_regionfile} -zoom to fit
	cd - &amp;&gt; /dev/null
	function_completed
	confirm
}

create_source_region_auto_then_quit(){
	functionname=&quot;create source region (auto)&quot;
	function_start
	cd $ip/${analysisfolder}/xis/image_analysis/
	if [ ! -f raw_images/fi_bin1.img ];
	then
		echo &quot; needed image file &#39;raw_images/fi_bin1.img&#39; was not found...&quot;
		echo &quot; please execute this command after executing &#39;Extract Raw Images&#39;&quot;
		return
	fi
	read -p &quot;input source region filename to be created &gt; &quot; source_regionfile
	<span style="text-decoration:line-through;color:blue;">xis_create_region_file_for.sh</span><span style="color:red;">hsXISCreateRegionFileFor</span> raw_images/fi_bin1.img regions/${source_regionfile}
	ds9 raw_images/fi_bin1.img -region regions/${source_regionfile} -zoom to fit -quit
	cd - &amp;&gt; /dev/null
	function_completed
	confirm
}



create_bgd_region_auto(){
	functionname=&quot;create source region (auto)&quot;
	function_start
	echo &quot;create bgd region (auto)&quot;
	cd $ip/${analysisfolder}/xis/image_analysis/
	if [ ! -f raw_images/fi_bin1.img ];
	then
		echo &quot; needed image file &#39;raw_images/fi_bin1.img&#39; was not found...&quot;
		echo &quot; please execute this command after executing &#39;Extract Raw Images&#39;&quot;
		return
	fi
	read -p &quot;input bgd region filename to be created &gt; &quot; bgd_regionfile
	yesno=`<span style="text-decoration:line-through;color:blue;">yesno.sh</span><span style="color:red;">hsYesOrNo</span> &quot;use default radius (inner=180\&quot;, outer=270\&quot;) [yes/no] &gt; &quot;`
	if [ $yesno = &quot;yes&quot; ];
	then
		inner=&quot;&quot;
		outer=&quot;&quot;
	else
		read -p &quot;input inner radius in arcsec &gt; &quot; inner
		read -p &quot;input outer radius in arcsec &gt; &quot; outer
	fi
	<span style="text-decoration:line-through;color:blue;">xis_create_bgd_region_file_for.sh</span><span style="color:red;">hsXISCreateBGDRegionFile</span> raw_images/fi_bin1.img regions/${bgd_regionfile} $inner $outer
	ds9 raw_images/fi_bin1.img -region regions/${bgd_regionfile} -zoom to fit
	cd - &amp;&gt; /dev/null
	function_completed
	confirm
}

create_bgd_region_auto_then_quit(){
	functionname=&quot;create source region (auto)&quot;
	function_start
	echo &quot;create bgd region (auto)&quot;
	cd $ip/${analysisfolder}/xis/image_analysis/
	if [ ! -f raw_images/fi_bin1.img ];
	then
		echo &quot; needed image file &#39;raw_images/fi_bin1.img&#39; was not found...&quot;
		echo &quot; please execute this command after executing &#39;Extract Raw Images&#39;&quot;
		return
	fi
	read -p &quot;input bgd region filename to be created &gt; &quot; bgd_regionfile
	yesno=`<span style="text-decoration:line-through;color:blue;">yesno.sh</span><span style="color:red;">hsYesOrNo</span> &quot;use default radius (inner=180\&quot;, outer=270\&quot;) [yes/no] &gt; &quot;`
	if [ $yesno = &quot;yes&quot; ];
	then
		inner=&quot;&quot;
		outer=&quot;&quot;
	else
		read -p &quot;input inner radius in arcsec &gt; &quot; inner
		read -p &quot;input outer radius in arcsec &gt; &quot; outer
	fi
	<span style="text-decoration:line-through;color:blue;">xis_create_bgd_region_file_for.sh</span><span style="color:red;">hsXISCreateBGDRegionFile</span> raw_images/fi_bin1.img regions/${bgd_regionfile} $inner $outer
	ds9 raw_images/fi_bin1.img -region regions/${bgd_regionfile} -zoom to fit -quit
	cd - &amp;&gt; /dev/null
	function_completed
	confirm
}


##################################
#extract filtered images
##################################
extract_filtered_images(){
	functionname=&quot;extract filtered images&quot;
	function_start
	#check region file existence
	check_regionfile_exsistence
	if [ $? = false ];
	then
		return
	fi
	#if region files are OK, then
	cd $ip/${analysisfolder}/xis/image_analysis/
	for file in xis0_evt.evt xis1_evt.evt xis2_evt.evt xis3_evt.evt fi_evt.evt bi_evt.evt;
	do
		eventfile=../data/$file
		if [ -f $eventfile ];then
			outputimage_source=filtered_images/$tag/`basename $file .evt`_`basename ${source_regionfile} .reg`.img
			outputimage_bgd=filtered_images/$tag/`basename $file .evt`_`basename ${bgd_regionfile} .reg`.img
			<span style="text-decoration:line-through;color:blue;">xis_extract_filtered_images.sh</span><span style="color:red;">hsXISExtractFilteredImage</span> $eventfile $outputimage_source regions/${source_regionfile} ${extraconditionfile}
			<span style="text-decoration:line-through;color:blue;">xis_extract_filtered_images.sh</span><span style="color:red;">hsXISExtractFilteredImage</span> $eventfile $outputimage_bgd regions/${bgd_regionfile} ${extraconditionfile}
		fi
	done
	cd - &amp;&gt; /dev/null
	function_completed
	confirm
}

check_filtered_images(){
	functionname=&quot;check filtered images&quot;
	function_start
	cd $ip/${analysisfolder}/xis/image_analysis/
	if [ -f filtered_images/${tag}/fi_evt_`basename ${source_regionfile} .reg`.img -a -f filtered_images/${tag}/fi_evt_`basename ${bgd_regionfile} .reg`.img ];
	then
		ds9 filtered_images/${tag}/fi_evt_`basename ${source_regionfile} .reg`.img -region regions/${source_regionfile} -zoom to fit filtered_images/${tag}/fi_evt_`basename ${bgd_regionfile} .reg`.img -region regions/${bgd_regionfile} -zoom to fit -frame 1 -zoom to fit
	else
		echo &quot; filtered images are not found&quot;
		echo &quot; use this command after extracting filtered images&quot;
	fi
	cd - &amp;&gt; /dev/null
	function_completed
	confirm
}

##################################
#create energy-band-divided img
##################################
extract_band_images(){
	functionname=&quot;extract_band_images&quot;
	function_start
	pushd $ip/${analysisfolder}/xis/image_analysis/ &amp;&gt; /dev/null
	echo &quot;Please input Energy Bnad to be used for band images...&quot; 
	read -p &quot;  Red image lower limit (keV) &gt; &quot; red_lower_e
	read -p &quot;  Red image upper limit (keV) &gt; &quot; red_upper_e
	read -p &quot;Green image lower limit (keV) &gt; &quot; green_lower_e
	read -p &quot;Green image upper limit (keV) &gt; &quot; green_upper_e
	read -p &quot; Blue image lower limit (keV) &gt; &quot; blue_lower_e
	read -p &quot; Blue image upper limit (keV) &gt; &quot; blue_upper_e
	
	for eventfile in ../data/fi_evt.evt ../data/bi_evt.evt;
	do
		if [ -f $eventfile ];
		then
			<span style="text-decoration:line-through;color:blue;">xis_extract_band_image.sh</span><span style="color:red;">hsXISExtractEnergySlicedImage</span> $eventfile band_images/${tag}/`basename $eventfile .evt` $red_lower_e $red_upper_e $green_lower_e $green_upper_e $blue_lower_e $blue_upper_e ${extraconditionfile}
		fi
	done
	popd &amp;&gt; /dev/null
	function_completed
	confirm
}

list_band_images(){
	pushd $ip/${analysisfolder}/xis/image_analysis/band_images
	if [ -d ${tag} ];
	then
		pushd ${tag} &amp;&gt; /dev/null &amp;&gt; /dev/null
		echo &quot;image_analysis/band_images/$tag contains...&quot;
		images=`ls -1 *.img 2&gt; /dev/null`
		for entry in $images
		do
			echo &quot; $entry&quot;
		done
		echo &quot;&quot;
                                                                                                        
		popd &amp;&gt; /dev/null
	else
		echo &quot;there is no band image...&quot;
	fi
	popd &amp;&gt; /dev/null
	confirm
}

display_band_images(){
	functionname=&quot;check filtered images&quot;
	function_start
	if [ -d $ip/${analysisfolder}/xis/image_analysis/band_images/${tag} ];
	then
		pushd $ip/${analysisfolder}/xis/image_analysis/band_images/$tag &amp;&gt; /dev/null
		echo &quot;image_analysis/band_images/$tag contains...&quot;
		images=`ls -1 *.img 2&gt; /dev/null`
		images_head1=`ls -1 *.img 2&gt; /dev/null | head -1`
		if [ _${images_head1} = _ ];
		then
			echo &quot;there is no band image...&quot;
			echo &quot;Please execute this command after executing &#39;extract_band_images&#39; command&quot;
		else
			for entry in $images
			do
				echo &quot; $entry&quot;
			done
			echo &quot;&quot;
			read -p &quot;Please input file name of Red-band image   &gt; &quot; red_band_image
			read -p &quot;Please input file name of Green-band image &gt; &quot; green_band_image
			read -p &quot;Please input file name of Blue-band image  &gt; &quot; blue_band_image
			if [ -f $red_band_image -a -f $green_band_image -a -f $blue_band_image ];
			then
				echo &quot;&quot;
				echo &quot;ds9 will run. Please close the DS9 window if you finish your operation.&quot;
				ds9 -rgb -red $red_band_image -green $green_band_image -blue $blue_band_image
			fi
			popd &amp;&gt; /dev/null
		fi
	else
		echo &quot;there is no band image...&quot;
		echo &quot;Please execute this command after executing &#39;extract_band_images&#39; command&quot;
	fi
	function_completed
	confirm
}

##################################
#create img pdf
##################################
create_img_pdf(){
	functionname=&quot;create img pdf&quot;
	function_start
	cd $ip/${analysisfolder}/xis/image_analysis/raw_images/
	<span style="text-decoration:line-through;color:blue;">fits_image_to_pdf.sh</span><span style="color:red;">hsFitsImageToPDF</span> fi_bin2.img fi_bin2.pdf
	cd - &amp;&gt; /dev/null
	function_completed
	confirm
}

check_img_pdf(){
	functionname=&quot;check raw img pdf&quot;
	function_start
	cd $ip/${analysisfolder}/xis/image_analysis/raw_images/
	`$HS_PDF_VIEWER fi_bin2.pdf`
	cd - &amp;&gt; /dev/null
	function_completed
	confirm
}

##################################
#extract source/bgd spectra
##################################
extract_spectra(){
	functionname=&quot;extract source/bgd spectra&quot;
	function_start
	#check region file existence
	check_regionfile_exsistence
	if [ $? = false ];
	then
		return
	fi
	#if region files are OK, then
	cd $ip/${analysisfolder}/xis/spectral_analysis/
	for xis in xis0 xis1 xis2 xis3 fi bi;
	do
		if [ -f ../data/${xis}_evt.evt ];
		then
			<span style="text-decoration:line-through;color:blue;">xis_extract_filtered_spectrum.sh</span><span style="color:red;">hsXISExtractFilteredSpectrum</span> ../data/${xis}_evt.evt pis/$tag/${xis}_`basename ${source_regionfile} .reg`.pi ../image_analysis/regions/${source_regionfile} ${extraconditionfile}
			<span style="text-decoration:line-through;color:blue;">xis_extract_filtered_spectrum.sh</span><span style="color:red;">hsXISExtractFilteredSpectrum</span> ../data/${xis}_evt.evt bgds/$tag/${xis}_`basename ${bgd_regionfile} .reg`.pi ../image_analysis/regions/${bgd_regionfile} ${extraconditionfile}
		fi
	done
	cd - &amp;&gt; /dev/null
	function_completed
	confirm
}

##################################
#create rmf
##################################
create_rmf(){
	functionname=&quot;create rmf&quot;
	function_start
	cd $ip/${analysisfolder}/xis/spectral_analysis/
	<span style="text-decoration:line-through;color:blue;">xis_create_response_matrix.sh</span><span style="color:red;">hsXISCreateResponseMatrix</span>
	cd - &amp;&gt; /dev/null
	function_completed
	confirm
}

##################################
#list response
##################################
list_responses(){
	cd $ip/${analysisfolder}/xis/spectral_analysis/responses/
	responses=`ls -1 *.rmf 2&gt; /dev/null`
	responses_head1=`ls -1 *.rmf 2&gt; /dev/null | head -1`
	cd - &amp;&gt; /dev/null
	if [ _$responses_head1 = _ ];
	then
		echo &quot;there are no response file...&quot;
	else
		echo &quot;spectral_analysis/responses/ contains...&quot;
		for entry in $responses;
		do
			echo &quot; $entry&quot;
		done
		echo &quot;&quot;
	fi
	confirm
}


##################################
#create arf
##################################
create_arf(){
	functionname=&quot;create arf&quot;
	function_start
	#check region file existence
	check_regionfile_exsistence
	if [ $? = false ];
	then
		return
	fi
	#if region files are OK, then
	cd $ip/${analysisfolder}/xis/spectral_analysis/
	for n in 0 1 2 3;
	do
		if [ -f ../data/xis${n}_evt.evt ];
		then
			<span style="text-decoration:line-through;color:blue;">xis_create_auxiliary_response_file_for_pointsource.sh</span><span style="color:red;">hsXISCreateARFForPointSouce</span> ../image_analysis/regions/${source_regionfile} $n
		fi
	done
	<span style="text-decoration:line-through;color:blue;">xis_merge_arfs_fibi.sh</span><span style="color:red;">hsXISMergeARFFIBI</span> ../image_analysis/regions/${source_regionfile}
	cd - &amp;&gt; /dev/null
	function_completed
	confirm
}

##################################
#list arfs
##################################
list_arfs(){
	cd $ip/${analysisfolder}/xis/spectral_analysis/arfs/
	arfs=`ls -1 *.arf`
	arfs_head1=`ls -1 *.arf | head -1`
	cd - &amp;&gt; /dev/null
	if [ _$arfs_head1 = _ ];
	then
		echo &quot;there are no arf...&quot;
	else
		echo &quot;spectral_analysis/arfs/ contains...&quot;
		for entry in $arfs;
		do
			echo &quot; $entry&quot;
		done
		echo &quot;&quot;
	fi
	confirm
}

##################################
#create spectra check plots
##################################
create_spectra_check_plot(){
	functionname=&quot;create spectra check plot&quot;
	function_start
	cd $ip/${analysisfolder}/xis/spectral_analysis/
	evtpi=pis/${tag}/fi_`basename ${source_regionfile} .reg`_bin20.pi
	if [ ! -f $evtpi ];
	then
		echo &quot;PI file is not found...&quot;
		cd - &amp;&gt; /dev/null
		return
	fi
	bgdpi=bgds/${tag}/fi_`basename ${bgd_regionfile} .reg`.pi
	if [ ! -f $bgdpi ];
	then
		echo &quot;BGD PI file is not found...&quot;
		cd - &amp;&gt; /dev/null
		return
	fi
	rmf=responses/fi.rmf
	if [ ! -f $rmf ];
	then
		echo &quot;response file is not found...&quot;
		cd - &amp;&gt; /dev/null
		return
	fi
	arf=arfs/fi_`basename ${source_regionfile} .reg`.arf
	if [ ! -f $arf ];
	then
		echo &quot;arf is not found...&quot;
		cd - &amp;&gt; /dev/null
		return
	fi
	<span style="text-decoration:line-through;color:blue;">xis_create_spectra_check_plot.sh</span><span style="color:red;">hsXISCreateSpectrumCheckPlot</span> $evtpi none none $bgdpi $rmf $arf plots/$tag/fi_`basename ${source_regionfile} .reg`_bin20.pdf &quot;`<span style="text-decoration:line-through;color:blue;">targetname.sh</span><span style="color:red;">hsFitsGetTargetName</span> $evtpi` / Regions ${source_regionfile} &amp; ${bgd_regionfile}&quot;
	cd - &amp;&gt; /dev/null
	function_completed
	confirm

}

check_spectra_check_plot(){
	functionname=&quot;check spectra check plot&quot;
	function_start
	check_regionfile_exsistence
	if [ $? -eq $false ];
	then
		echo &quot;please execute this command after preoaration of region files&quot;
		confirm
		cd - &amp;&gt; /dev/null
		return
	fi
	cd $ip/${analysisfolder}/xis/spectral_analysis/
	pdffile=plots/$tag/fi_`basename ${source_regionfile} .reg`_bin20.pdf
	if [ -f $pdffile ];
	then
		echo &quot;opening $ip/${analysisfolder}/xis/spectral_analysis/$pdffile&quot;
		`$HS_PDF_VIEWER $pdffile`
	else
		echo &quot; file not found...execute this command after completing &#39;Create Spectra Check Plot&#39;&quot;
		confirm
		cd - &amp;&gt; /dev/null
		return
	fi
	cd - &amp;&gt; /dev/null
	function_completed
	confirm
}

##################################
#extract lightcurves
##################################
extract_lightcurves(){
	functionname=&quot;extract lightcurves&quot;
	function_start
	#check region file existence
	check_regionfile_exsistence
	if [ $? = false ];
	then
		return
	fi
	
	echo &quot;&quot;
	echo &quot;Input Bin Size and Energy Band to be used in lightcurve extraction&quot;
	echo &quot;Note: Bin Size is normally a multiple of 8 sec since the XIS&#39;s frame&quot;
	echo &quot;      exposure is 8sec in normal mode.&quot;
	echo &quot;&quot;
	read -p &quot; Bin Size (sec)    &gt; &quot; binsize
	read -p &quot; Lower Limit (keV) &gt; &quot; lower_e
	read -p &quot; Upper Limit (keV) &gt; &quot; upper_e
	band=&quot;band`echo $lower_e | sed -e &#39;s/\.//g&#39;`_`echo $upper_e | sed -e &#39;s/\.//g&#39;`keV&quot;
	lower_pi=`<span style="text-decoration:line-through;color:blue;">xis_energy_to_pi.sh</span><span style="color:red;">hsXISEnergyToPI</span> $lower_e`
	upper_pi=`<span style="text-decoration:line-through;color:blue;">xis_energy_to_pi.sh</span><span style="color:red;">hsXISEnergyToPI</span> $upper_e`
	
	echo &quot;&quot;
	echo &quot;Select Lightcurve Plot Appearance&quot;
	yesno=`<span style="text-decoration:line-through;color:blue;">yesno.sh</span><span style="color:red;">hsYesOrNo</span> &quot; Source ALL Lightcurve (yes/no) &gt; &quot;`
	if [ $yesno = yes ];
	then
		show_sourcelc=true
	else
		show_sourcelc=false
	fi
	yesno=`<span style="text-decoration:line-through;color:blue;">yesno.sh</span><span style="color:red;">hsYesOrNo</span> &quot; Background Lightcurve (yes/no) &gt; &quot;`
	if [ $yesno = yes ];
	then
		show_bgdlc=true
	else
		show_bgdlc=false
	fi
	yesno=`<span style="text-decoration:line-through;color:blue;">yesno.sh</span><span style="color:red;">hsYesOrNo</span> &quot; Source-BGD Lightcurve (yes/no) &gt; &quot;`
	if [ $yesno = yes ];
	then
		show_sourcesubbgd=true
	else
		show_sourcesubbgd=false
	fi
	
	#if region files are OK, then
	pushd $ip/${analysisfolder}/xis/lightcurve_analysis/ &amp;&gt; /dev/null
	for file in fi_evt.evt bi_evt.evt;
	do
		eventfile=../data/$file
		if [ -f $eventfile ];then
			#create extracondition
			extraconditionfile=extraconditions/$tag/pha_cut.filter
			mkdir -p `dirname $extraconditionfile` &amp;&gt; /dev/null
			echo &quot;filter pha_cut $lower_pi $upper_pi&quot; &gt; $extraconditionfile
			#extract lightcurve
			outputprefix_source=lcfiles/$tag/`basename $eventfile .evt`_`basename $source_regionfile .reg`_$band
			<span style="text-decoration:line-through;color:blue;">xis_extract_lightcurve_with_gti.sh</span><span style="color:red;">hsXISExtractLightcurveWithGTI</span> $eventfile ../image_analysis/regions/$source_regionfile $gtifile $outputprefix_source $binsize $extraconditionfile
			outputprefix_bgd=lcfiles/$tag/`basename $eventfile .evt`_`basename $bgd_regionfile .reg`_$band
			<span style="text-decoration:line-through;color:blue;">xis_extract_lightcurve_with_gti.sh</span><span style="color:red;">hsXISExtractLightcurveWithGTI</span> $eventfile ../image_analysis/regions/$bgd_regionfile $gtifile $outputprefix_bgd $binsize $extraconditionfile
			#plot
			sourcelc=${outputprefix_source}_bin${binsize}.lc
			bgdlc=${outputprefix_bgd}_bin${binsize}.lc
			outputprefix=plots/$tag/`basename $eventfile .evt`_`basename $source_regionfile .reg`_subtract_`basename $bgd_regionfile .reg`_bin_${binsize}_$band
			<span style="text-decoration:line-through;color:blue;">xis_plot_lightcurves.sh</span><span style="color:red;">hsXISPlotLightcurve</span> $sourcelc $bgdlc $outputprefix $show_sourcelc $show_bgdlc $show_sourcesubbgd
		fi
	done
	popd &amp;&gt; /dev/null
	function_completed
	confirm
}

##################################
#list lightcurves
##################################
list_lightcurve_files(){
	if [ ! -d $ip/${analysisfolder}/xis/lightcurve_analysis/lcfiles/${tag} ];
	then
		echo &quot;there are no lightcurve (.lc) file...&quot;
		confirm
		return
	fi
	pushd $ip/${analysisfolder}/xis/lightcurve_analysis/lcfiles/$tag/ &amp;&gt; /dev/null
	files=`ls -1 *.lc 2&gt; /dev/null`
	files_head1=`ls -1 *.lc 2&gt; /dev/null | head -1`
	popd &amp;&gt; /dev/null
	if [ _$files_head1 = _ ];
	then
		echo &quot;there are no lightcurve (.lc) file...&quot;
	else
		echo &quot;lightcurve_analysis/lcfiles/$tag/ contains...&quot;
		for entry in $files;
		do
			echo &quot; $entry&quot;
		done
		echo &quot;&quot;
	fi
	confirm
}

list_lightcurve_plots(){
	if [ ! -d $ip/${analysisfolder}/xis/lightcurve_analysis/plots/${tag} ];
	then
		echo &quot;there are no lightcurve plot file...&quot;
		confirm
		return
	fi
	cd $ip/${analysisfolder}/xis/lightcurve_analysis/plots/$tag/
	files=`ls -1 *.pdf 2&gt; /dev/null`
	files_head1=`ls -1 *.pdf 2&gt; /dev/null | head -1`
	cd - &amp;&gt; /dev/null
	if [ _$files_head1 = _ ];
	then
		echo &quot;there are no lightcurve plot file...&quot;
	else
		echo &quot;lightcurve_analysis/plots/$tag/ contains...&quot;
		for entry in $files;
		do
			echo &quot; $entry&quot;
		done
		echo &quot;&quot;
	fi
	confirm
}

##################################
#display lightcurve plot
##################################
display_lightcurve_plot(){
	functionname=&quot;display lightcurve plot&quot;
	function_start
	if [ -d $ip/${analysisfolder}/xis/lightcurve_analysis/plots/${tag} ];
	then
		pushd $ip/${analysisfolder}/xis/lightcurve_analysis/plots/${tag} &amp;&gt; /dev/null
		echo &quot;lightcurve_analysis/lcfiles/${tag} contains...&quot;
		files=`ls -1 *.pdf 2&gt; /dev/null`
		files_head1=`ls -1 *.pdf 2&gt; /dev/null | head -1`
		if [ _${files_head1} = _ ];
		then
			echo &quot;there is no lightcurve plot file...&quot;
			echo &quot;Please execute this command after executing &#39;Extract Source/BGD Lightcurves&#39; command&quot;
		else
			for entry in $files
			do
				echo &quot; $entry&quot;
			done
			echo &quot;&quot;
			read -p &quot;Please select a filename to be displayed &gt; &quot; filename
			if [ -f $filename ];
			then
				echo &quot;&quot;
				echo &quot;PDF viewer will run. Please close the viewer window if you finish your operation.&quot;
				$HS_PDF_VIEWER $filename
			else
				echo &quot;file &#39;$filename&#39; not found...&quot;
			fi
			popd &amp;&gt; /dev/null
		fi
	else
		echo &quot;there is no lightcurve plot...&quot;
		echo &quot;Please execute this command after executing &#39;Extract Source/BGD Lightcurves&#39; command&quot;
	fi
	function_completed
	confirm
}

##################################
#END OF SUB ROUTINES SECTION
##################################
##################################


##################################
##################################
#MAIN LOOP
##################################
command=000
while [ ! $command = 999 ];
do
	show_menu
	read -p &quot;select command number &gt; &quot; command
	echo &quot;&quot;
	if [ _$command = _ ];
	then
		command=000
	fi
	case $command in
		100) link_event ;;
		200) set_analysis_tagname ;;
		210) set_regionfilenames ;;
		211) list_region_files ;;
		220) set_gtifilename;;
		230) set_extraconditionfilename;;
		300) extract_raw_images ;;
		301) check_raw_images ;;
		302) create_img_pdf ;;
		303) check_img_pdf ;;
		310) create_source_region_auto ;;
		311)  ;;
		312) create_source_region_auto_then_quit ;;
		320) create_bgd_region_auto ;;
		321)  ;;
		322) create_bgd_region_auto_then_quit ;;
		330) extract_filtered_images ;;
		331) check_filtered_images ;;
		340) extract_band_images ;;
		341) list_band_images ;;
		342) display_band_images ;;
		400) extract_spectra ;;
		410) create_rmf ;;
		411) list_responses ;;
		420) create_arf ;;
		421) list_arfs ;;
		430) create_spectra_check_plot ;;
		431) check_spectra_check_plot ;;
		500) extract_lightcurves ;;
		501) list_lightcurve_files ;;
		502) list_lightcurve_plots ;;
		503) display_lightcurve_plot ;;
		510) calculate_powerspectrum ;;
		520) search_periodicity ;;
		530) fold_lightcurve ;;
		999) exit ;;
		default) ;;
	esac
	
	echo &quot;&quot;

done
##################################
#END OF MAIN LOOP
##################################
##################################
</pre>
</body>
</html>
