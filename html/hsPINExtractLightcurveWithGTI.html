<html>
<body>
<pre>
#!/bin/bash

#20090305 Takayuki Yuasa
#20090527 Takayuki Yuasa added energy cut in default
#20090608 Takayuki Yuasa added label to show cut energy

#<span style="text-decoration:line-through;color:blue;">pin_extract_spectrum_with_gti.sh</span><span style="color:red;">hsPINExtractSpectrumWithGTI</span>

if [ _$6 = _ ];
then
cat &lt;&lt; EOF
usage :
<span style="text-decoration:line-through;color:blue;">pin_extract_lightcurve_with_gti.sh</span><span style="color:red;">hsPINExtractLightcurveWithGTI</span> \\
                      (1:cleaned event file) \\
                      (2:NXB file) \\
                      (3:pseudo event file) \\
                      (4:GTI file) \\
                      (5:output file prefix) \\
                      (6:bin size in a unit of sec) \\
                      (7:extra_condition_file;optional)

note : output pdf file is created as (output file prefix).pdf
EOF
exit
fi

################################
#parameter set
################################
evt_file=$1
nxb_file=$2
pse_file=$3
gti_file=$4
outputprefix=$5
outputdir=`dirname $5`
binsize=$6

#default pha cut 28-187 means a filtering with 10-70keV in energy
default_pha_cut=&quot;28 187&quot;

#extra condition file
#also apply default pha_cut
tmp_pha_cut=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`
echo &quot;filter pha_cut $default_pha_cut&quot; &gt; $tmp_pha_cut
if [ _$7 != _ ];
then
if [ -f $7 ];
then
condition=`cat $tmp_pha_cut $7`
condition_for_pseudo=`sed -e &#39;s/\(filter\ *pha_\)/!\1/g&#39; $7`
fi
else
condition=`cat $tmp_pha_cut`
condition_for_pseudo=&quot;&quot;
fi
rm $tmp_pha_cut

#log file
logfile=${outputprefix}.log
tmp=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`
touch $logfile
touch $tmp

#########
#function
#########
function create_lc() {
#input function_in_file
#input function_out_lc&lt;br /&gt;
function_out_lc_lc=${function_out_lc}.lc
function_out_lc_ps=${function_out_lc}.ps
function_out_lc_pco=${function_out_lc}.pco
function_out_lc_qdp=${function_out_lc}.qdp

rm -f $function_out_lc_lc
rm -f $function_out_lc_ps $function_out_lc_pdf
rm -f $function_out_lc_pco $function_out_lc_qdp

tstart=`<span style="text-decoration:line-through;color:blue;">getheader.sh</span><span style="color:red;">hsFitsGetHeader</span> $function_in_file 0 TSTART`

xselect &lt;&lt; EOF 2&gt;&amp;1 | tee $tmp

no

read event $function_in_file ./
filter time file $gti_file
$condition
extract event
set binsize $binsize
extract curve exposure=0.0
save curve $function_out_lc_lc
exit
no

EOF
cat $tmp &gt;&gt; $logfile

#get pha min max from evtlc
phalowcut=`<span style="text-decoration:line-through;color:blue;">getheader.sh</span><span style="color:red;">hsFitsGetHeader</span> ${evtlc} 1 phalcut`
phahighcut=`<span style="text-decoration:line-through;color:blue;">getheader.sh</span><span style="color:red;">hsFitsGetHeader</span> ${evtlc} 1 phahcut`
energy_lowcut=`<span style="text-decoration:line-through;color:blue;">pin_pi_to_energy.rb</span><span style="color:red;">hsPINPIToEnergy</span> $phalowcut`
energy_highcut=`<span style="text-decoration:line-through;color:blue;">pin_pi_to_energy.rb</span><span style="color:red;">hsPINPIToEnergy</span> $phahighcut`

cps=`grep counts/sec $tmp | awk &#39;{print $8}&#39;`
xselect &lt;&lt; EOF 2&gt;&amp;1 | tee $tmp

no

read event $function_in_file ./
filter time file $gti_file
$condition
extract event
set binsize $binsize
extract curve exposure=0.0
plot curve
/NULL
ti off
cs 1.3
lwidth 3
lwidth 3 on 1..50
la ot
la t
la f `<span style="text-decoration:line-through;color:blue;">targetname.sh</span><span style="color:red;">hsFitsGetTargetName</span> $function_in_file` / `basename $function_in_file` / $binsize s bin / ${energy_lowcut}-${energy_highcut} keV
la x TIME s (TSTART=$tstart or `<span style="text-decoration:line-through;color:blue;">suzaku_missiontime_to_utc.sh</span><span style="color:red;">hsSuzakuMissionTimeToUTC</span> $tstart`)
mark 17 on 2
r y 0 `calc $cps*1.6`
we $function_out_lc
hard $function_out_lc_ps/cps
exit

exit
no

EOF
cd `dirname $function_out_lc`
ps2pdf `basename $function_out_lc_ps`
cd -
}
#end of create_lc()

################################
#execution
################################
rm -f $logfile

##event lc
function_in_file=$evt_file
function_out_lc=${outputprefix}_evt_bin${binsize}
create_lc

##nxb lc
function_in_file=$nxb_file
function_out_lc=${outputprefix}_nxb_bin${binsize}
create_lc

##pseudo
###create pure pseudo
tmp_purepseudo=pure_pseudo.evt
rm -f $tmp_purepseudo &amp;&gt; /dev/null
fselect infile=${pse_file}+1 outfile=$tmp_purepseudo expr=&quot;GRADE_HITPAT&lt;=1&amp;&amp;GRADE_QUALTY==0&quot; histkw=yes

###replace condition variable
condition=$condition_for_pseudo

###execute pseudo extraction
function_in_file=$tmp_purepseudo
function_out_lc=${outputprefix}_pse_bin${binsize}
create_lc


#cleaning
rm $tmp
rm $tmp_purepseudo

################################
#log
################################
</pre>
</body>
</html>
