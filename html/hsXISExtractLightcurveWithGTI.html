<html>
<body>
<pre>
#!/bin/bash

#20090608 Takayuki Yuasa
#20090714 Takayuki Yuasa yaxis label fixed, extra condition bug fix

if [ _$5 = _ ];
then
cat &lt;&lt; EOF
usage :
<span style="text-decoration:line-through;color:blue;">xis_extract_lightcurve_with_gti.sh</span><span style="color:red;">hsXISExtractLightcurveWithGTI</span> \\
                      (1:event file) \\
                      (2:region file) \\
                      (3:GTI file) \\
                      (4:output file prefix) \\
                      (5:bin size in a unit of sec) \\
                      (6:extra_condition_file;optional)

note : output pdf file is created as (output file prefix).pdf
EOF
exit
fi

################################
#parameter set
################################
evt_file=$1
region_file=$2
gti_file=$3
outputprefix=$4
outputdir=`dirname $4`
binsize=$5

#default pha cut 137-2740 means a filtering with 0.5-10keV in energy
default_pha_cut=&quot;137 2740&quot;

#extra condition file
#also apply default pha_cut
tmp_pha_cut=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`
echo &quot;filter pha_cut $default_pha_cut&quot; &gt; $tmp_pha_cut
if [ _$6 != _ ];
then
	if [ -f $6 ];
	then
		condition=`cat $tmp_pha_cut $6`
	else
		condition=`cat $tmp_pha_cut`
	fi
else
	condition=`cat $tmp_pha_cut`
fi
rm $tmp_pha_cut

#check
if [ -f $region_file ];
then
echo &quot;region file found...OK&quot;
else
echo &quot;region file not found...exit&quot;
exit
fi

#create directory
if [ ! -d `dirname $outputprefix` ];
then
mkdir -p `dirname $outputprefix`
fi

#log file
logfile=${outputprefix}.log
tmp=`<span style="text-decoration:line-through;color:blue;">get_hash_random.pl</span><span style="color:red;">hsHashRandom</span>`
touch $logfile
touch $tmp

#########
#function
#########
function create_lc() {
#input function_in_file
#input function_out_lc
function_out_lc_lc=${function_out_lc}.lc
function_out_lc_ps=${function_out_lc}.ps
function_out_lc_pco=${function_out_lc}.pco
function_out_lc_qdp=${function_out_lc}.qdp

rm -f $function_out_lc_lc
rm -f $function_out_lc_ps $function_out_lc_pdf
rm -f $function_out_lc_pco $function_out_lc_qdp

tstart=`<span style="text-decoration:line-through;color:blue;">getheader.sh</span><span style="color:red;">hsFitsGetHeader</span> $function_in_file 0 TSTART`

xselect &lt;&lt; EOF 2&gt;&amp;1 | tee $tmp

no

read event $function_in_file ./
filter time file $gti_file
filter region $region_file
$condition
extract event
set binsize $binsize
extract curve exposure=0.0
save curve $function_out_lc_lc
exit
no

EOF
cat $tmp &gt;&gt; $logfile
cps=`grep counts/sec $tmp | awk &#39;{print $8}&#39;`

#get pha min max from evtlc
phalowcut=`<span style="text-decoration:line-through;color:blue;">getheader.sh</span><span style="color:red;">hsFitsGetHeader</span> $function_out_lc_lc 1 phalcut`
phahighcut=`<span style="text-decoration:line-through;color:blue;">getheader.sh</span><span style="color:red;">hsFitsGetHeader</span> $function_out_lc_lc 1 phahcut`
energy_lowcut=`<span style="text-decoration:line-through;color:blue;">xis_pi_to_energy.sh</span><span style="color:red;">hsXISPIToEnergy</span> $phalowcut`
energy_lowcut=`ruby -e &quot;puts sprintf(&#39;%.1f&#39;,$energy_lowcut)&quot;`
energy_highcut=`<span style="text-decoration:line-through;color:blue;">xis_pi_to_energy.sh</span><span style="color:red;">hsXISPIToEnergy</span> $phahighcut`
energy_highcut=`ruby -e &quot;puts sprintf(&#39;%.1f&#39;,$energy_highcut)&quot;`

xselect &lt;&lt; EOF 2&gt;&amp;1 | tee $tmp

no

read event $function_in_file ./
filter time file $gti_file
filter region $region_file
$condition
extract event
set binsize $binsize
extract curve exposure=0.0
plot curve
/NULL
ti off
cs 1.3
lwidth 3
lwidth 3 on 1..50
la ot
la t
la f `<span style="text-decoration:line-through;color:blue;">targetname.sh</span><span style="color:red;">hsFitsGetTargetName</span> $function_in_file` / `basename $function_in_file` / $binsize s bin / ${energy_lowcut}-${energy_highcut} keV
la x TIME s (TSTART=$tstart or `<span style="text-decoration:line-through;color:blue;">suzaku_missiontime_to_utc.sh</span><span style="color:red;">hsSuzakuMissionTimeToUTC</span> $tstart`)
la y Counts s\u-1\d
mark 17 on 2
r y 0 `calc $cps*1.6`
we $function_out_lc
hard $function_out_lc_ps/cps
exit

exit
no

EOF
pushd `dirname $function_out_lc` &amp;&gt; /dev/null
ps2pdf `basename $function_out_lc_ps`
popd &amp;&gt; /dev/null
}
#end of create_lc()

################################
#execution
################################
rm -f $logfile

##event lc
function_in_file=${evt_file}
function_out_lc=${outputprefix}_bin${binsize}
create_lc

#cleaning
rm $tmp

################################
#log
################################
</pre>
</body>
</html>
